# âš¡ EDF FreePhase Dynamic Tariff â€” Home Assistant Integration

[![hacs_badge](https://img.shields.io/badge/HACS-Custom-41BDF5.svg)](https://hacs.xyz/)
![GitHub release](https://img.shields.io/github/v/release/jswilkinson851/ha-edf-freephase-dynamic-tariff)
![GitHub license](https://img.shields.io/github/license/jswilkinson851/ha-edf-freephase-dynamic-tariff)
![GitHub last commit](https://img.shields.io/github/last-commit/jswilkinson851/ha-edf-freephase-dynamic-tariff)
![installation_badge](https://img.shields.io/badge/dynamic/json?color=41BDF5&logo=home-assistant&label=integration%20usage&suffix=%20installs&cacheSeconds=15600&url=https://analytics.home-assistant.io/custom_integrations.json&query=$.edf_freephase_dynamic_tariff.total)

This integration brings **live electricity prices**, **halfâ€‘hourly rate data**, **standing charges**, and **cost tracking** for the **EDF FreePhase Dynamic** tariff directly into Home Assistant.

Itâ€™s built for UK users on the FreePhase Dynamic tariff and gives you everything you need to automate, plan, and understand your energy usage â€” all using the same Kraken API that EDF themselves rely on.

---

# âœ¨ What This Integration Can Do

## ğŸ”¹ Automatic Region & Tariff Detection
Just choose your region â€” the integration fetches the correct tariff code for you.  
If EDFâ€™s API is down, it falls back to a complete builtâ€‘in list.

## ğŸ”¹ Smarter Refresh Timing (Aligned Scheduler)
Updates happen exactly on the minute or halfâ€‘hour (depending on your settings), with a tiny bit of random delay to avoid everyone hitting the API at once.

## ğŸ”¹ Cost Tracking (Improved in v0.6.1)
If you provide your electricity import sensor, the integration can calculate:
- Todayâ€™s cost  
- Yesterdayâ€™s cost  
- Cost per slot  
- Cost per phase (Green/Amber/Red)  
- **Standingâ€‘charge cost contribution (NEW)**  
- **Total cost including standing charge (NEW)**  

This uses your real meter readings, so the numbers are accurate and reflect your actual billable usage.

## ğŸ”¹ Standing Charges (NEW in v0.6.1)
The integration now fetches and exposes:
- Standing charge (inc VAT)  
- Standing charge (exc VAT)  
- Validity dates  
- Raw EDF API data  

A dedicated sensor â€” **`sensor.standing_charge`** â€” provides this information cleanly, with GBP/day included as an attribute.

## ğŸ”¹ Debug Logging Switch
Turn detailed logging on or off from the Options Flow â€” no YAML, no restarts.

## ğŸ”¹ Better Diagnostics
A single diagnostic sensor now shows:
- API health  
- Scheduler timing  
- Current/next slot  
- Phase windows  
- Tariff metadata  
- Debug logs  
- Cost engine status  
- **Standingâ€‘charge heartbeat flags (NEW)**  

Perfect for troubleshooting or building a â€œhealth panelâ€.

## ğŸ”¹ Binary Sensor
- **Is it a Green slot right now?**  
  Now you have a simple yes/no sensor for that.

## ğŸ”¹ Clean Device Grouping
All sensors and binary sensors appear under one device in Home Assistant.

---

# ğŸ› ï¸ Installation (HACS)

## Option 1 â€” HACS Custom Repository (recommended)

[![Add to HACS](https://my.home-assistant.io/badges/hacs_repository.svg)](https://my.home-assistant.io/redirect/hacs_repository/?owner=jswilkinson851&repository=ha-edf-freephase-dynamic-tariff)

1. Open **HACS â†’ Integrations â†’ Custom Repositories**  
2. Add this URL:  
   https://github.com/jswilkinson851/ha-edf-freephase-dynamic-tariff  
3. Choose **Integration**  
4. Install  
5. Restart Home Assistant  
6. Add the integration via **Settings â†’ Devices & Services**

## Option 2 â€” Manual Install
Copy the folder into `custom_components/`, restart HA, and add the integration.

---

# ğŸ—ºï¸ Region Codes

The integration fetches regionâ€‘specific tariff codes from EDFâ€™s public API.  
Each region has a letter (Aâ€“P).  
If the API is down, the integration uses a builtâ€‘in list so setup still works.

---

# âš™ï¸ Configuration Options

### **Region**
Pick your region from the list. The integration handles the tariff code.

### **Scan Interval**
How often the integration refreshes prices.  
Updates happen on exact clock boundaries (e.g., 12:00, 12:30).

### **Import Sensor (optional, but recommended)**
If you provide your electricity import meter, the integration can calculate:
- Todayâ€™s cost  
- Yesterdayâ€™s cost  
- Slotâ€‘level cost  
- **Standingâ€‘charge cost contribution (NEW)**  

### **Debug Logging**
A simple toggle in the Options Flow.  
Useful if youâ€™re troubleshooting or want to see what the coordinator is doing.

---

# ğŸ“¡ Available Entities

## ğŸ”¹ Pricing Sensors
- `Current price`  
- `Next slot price`  
- `Cheapest slot in next 24 hours`  
- `Most expensive slot in next 24 hours`  

## ğŸ”¹ Standing Charge Sensors (NEW)
- `Standing Charge` (p/day, inc VAT)  
  - Attributes: exc VAT, GBP/day, validity dates, raw EDF data  

## ğŸ”¹ Cost Sensors
- `Cost today`  
- `Cost yesterday`  
- `Cost per slot`  
- `Cost per phase`  
- **Total cost including standing charge (NEW)**  

## ğŸ”¹ Slot & Block Sensors
- `Current slot colour`  
- `Current block summary`  
- `Next block summary`  
- `Next green/amber/red slot`  

## ğŸ”¹ Binary Sensors
- `Is the current slot green?`

## ğŸ”¹ Debug Sensors
- `Next refresh time`  
- `Debug logging enabled`  
- `Debug buffers`  

## ğŸ”¹ Health & Metadata Sensors
- `API latency`  
- `Last updated`  
- `Last successful update`  
- `Data age`  
- `Coordinator status`  
- **Standingâ€‘charge heartbeat flags**

---

## ğŸ”¹ Tariff Slot & Phase Events (NEW in v0.7.0)

This release introduces a full **event platform** for Home Assistant, allowing you to react instantly to changes in EDFâ€™s dynamic tariff.  
A new entity â€” **Tariff Slot & Phase Events** â€” emits structured events whenever the tariff changes in a meaningful way.

### ğŸ§™â€â™‚ï¸ What events are emitted?

The integration now fires the following event types:

- `edf_fpd_slot_changed`
- `edf_fpd_phase_changed`
- `edf_fpd_phase_started`
- `edf_fpd_phase_ended`
- `edf_fpd_phase_block_changed`
- `edf_fpd_next_phase_changed`
- `edf_fpd_next_green_phase_changed`
- `edf_fpd_next_amber_phase_changed`
- `edf_fpd_next_red_phase_changed`

Each event includes a rich payload describing the transition, including:
- previous and next slot  
- previous and next phase  
- block summaries  
- timestamps  
- price information  
- colour (green/amber/red)  
- duration and window boundaries  

Perfect for automations that need to respond *immediately* to tariff changes.

---

## ğŸ”¹ Event Diagnostics (NEW in v0.7.0)

The diagnostic sensor now includes a full **event diagnostics** section:

- `last_event_type`
- `last_event_timestamp`
- `event_counts` (perâ€‘type counters)
- `event_history` (chronological, structured, inâ€‘memory)

This makes it easy to build dashboards showing:
- recent tariff transitions  
- phase windows  
- slot changes  
- nextâ€‘phase predictions  
- debug traces  

---

## ğŸ”¹ Debug Event Stream (NEW in v0.7.0)

If debug logging is enabled, the integration also emits a structured debug event:

`edf_fpd_debug`


This includes:
- event type  
- payload  
- entity ID  

Useful for advanced dashboards, log consoles, or development.

---

## ğŸ”¹ Example Automation (NEW in v0.7.0)

Hereâ€™s a simple automation that triggers when a new phase begins:

```yaml
alias: Notify when a new tariff phase starts
trigger:
  - platform: event
    event_type: edf_fpd_phase_started
action:
  - service: notify.mobile_app_phone
    data:
      message: >
        New tariff phase started: {{ trigger.event.data.phase }}
```

---

# ğŸ“Š Example Dashboard Card


```
type: entities
title: Daily Tariff Summary
entities:
  - entity: sensor.today_s_rates_summary
    name: Todayâ€™s Rates
  - entity: sensor.tomorrow_s_rates_summary
    name: Tomorrowâ€™s Rates
  - type: divider
  - entity: sensor.current_price
    name: Current Price
  - entity: sensor.edf_freephase_dynamic_next_slot_price
    name: Next Slot Price
  - entity: sensor.edf_freephase_dynamic_current_slot_colour
    name: Current Slot Colour
  - entity: sensor.standing_charge
    name: Standing Charge
```

Other example dashboards and automations are available from: https://github.com/jswilkinson851/ha-edf-freephase-dynamic-tariff/tree/main/examples

---

# ğŸ©º Diagnostics

The downloadable diagnostics include:
- `Tariff metadata`  
- `Region label`  
- `API URLs`  
- `Current slot`  
- `Block summaries`  
- `Scheduler timing`  
- `Heartbeat flags`  
- `Debug logs`  
- `Cost engine status`  
- **`Standingâ€‘charge` values and raw API data (NEW in v0.6.1)**  

This makes it much easier to understand whatâ€™s happening behind the scenes.

---

# ğŸ›Ÿ Troubleshooting

- If the region list looks short, EDFâ€™s API may be having a moment â€” try again later.  
- Removing and reâ€‘adding the integration refreshes the region list.  
- If the API goes offline, the integration keeps using the last good data.  
- Turn on debug logging in the Options Flow if you need deeper insight.

---

# ğŸ“œ Changelog

Full release notes:  
https://github.com/jswilkinson851/ha-edf-freephase-dynamic-tariff/releases

---

# ğŸ“„ License

MIT License.

---

# âš ï¸ Disclaimer

This is a community project and is **not affiliated with EDF Energy** or the Kraken platform.  
All trademarks belong to their respective owners.