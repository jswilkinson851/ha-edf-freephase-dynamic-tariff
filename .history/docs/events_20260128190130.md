# ğŸ”” Tariff Slot & Phase Events

As of **v0.7.0**, this integration includes a full **event platform** that emits structured Home Assistant events whenever EDFâ€™s dynamic tariff changes in a meaningful way.

These events allow you to build automations that react instantly to:
- phase changes (green â†’ amber â†’ red)
- upcoming phase changes
- phase windows approaching their end

The event system is intentionally simple, predictable, and focused on realâ€‘world automation needs. 

---

# ğŸ“¡ Event Entity

`event.edf_fpd_phase_events`

This entity emits all tariffâ€‘related events and exposes diagnostic attributes:

- `last_event_type`
- `last_event_timestamp`
- `last_event_payload`
- `event_counts`
- `event_history`

Friendly name:

- `EDF FPD Phase Events`

---

# ğŸ§™â€â™‚ï¸ Event Types

All event types follow the naming convention:

- `edf_fpd_<description>`


The following events may be emitted:

| Event Type | Description |
|------------|-------------|
| `edf_fpd_slot_changed` | The current halfâ€‘hour slot changed. |
| `edf_fpd_phase_changed` | The tariff phase (green/amber/red) changed. |
| `edf_fpd_phase_started` | A new phase window began. |
| `edf_fpd_phase_ended` | A phase window ended. |
| `edf_fpd_phase_block_changed` | The merged block (group of sameâ€‘colour slots) changed. |
| `edf_fpd_next_phase_changed` | The predicted next phase changed. |
| `edf_fpd_next_green_phase_changed` | The next green phase changed. |
| `edf_fpd_next_amber_phase_changed` | The next amber phase changed. |
| `edf_fpd_next_red_phase_changed` | The next red phase changed. |
| `edf_fpd_debug` | Debug event stream (only when debug logging is enabled). |

---

# ğŸ“¦ Event Payload Structure

Each event includes a structured JSON payload.  
Example:

```json
{
  "event_type": "edf_fpd_phase_changed",
  "timestamp": "2026-01-25T20:00:03.050683+00:00",
  "phase": "amber",
  "from": {
    "phase": "green",
    "start": "19:30"
  },
  "to": {
    "phase": "amber",
    "start": "20:00"
  }
}
```

Payloads may include:

- phase
- from / to objects
- slot boundaries
- phase summaries
- price information
- timestamps
- colour (green/amber/red)
- duration and window metadata

## ğŸ§ª Example Automations

### Notify when a new phase starts

```yaml
alias: Notify on new tariff phase
trigger:
  - platform: event
    event_type: edf_fpd_phase_changed
action:
  - service: notify.mobile_app_phone
    data:
      message: >
        New tariff phase: {{ trigger.event.data.to | title }}
        ({{ trigger.event.data.phase.start }} â†’ {{ trigger.event.data.phase.end }})
```

### Trigger when the next green window becomes available

```yaml
alias: Prepare for next green window
trigger:
  - platform: event
    event_type: edf_fpd_next_phase_changed
condition:
  - condition: template
    value_template: >
      {{ trigger.event.data.to == 'green' }}
action:
  - service: script.prepare_for_green_window
```

## ğŸ“Š Example Dashboard Card

```yaml
type: markdown
title: EDF Event Timeline
content: |
  {% set diag = states['event.edf_fpd_tariff_slot_phase_events'].attributes %}
  {% if diag %}
  {% set history = diag["event_history"] %}
  {% for item in history | reverse %}
  **{{ item["timestamp"] }}**  
  ğŸ§™â€â™€ï¸ğŸª„â±ï¸ *{{ item["event_type"] }}*

  ```yaml
  {{ item["payload"] }}
  {% endfor %}
  {% endif %}
```

## ğŸ§  Debug Event Stream
If debug logging is enabled, the integration also emits:

- `edf_fpd_debug`

This includes:

- event type
- payload
- entity ID

Useful for advanced dashboards or development.

## ğŸ“Œ Notes
Event history is stored in memory only.

Events are emitted immediately when the coordinator detects a transition.

All event types follow the naming conventions documented in naming.md.

The event entity name was updated in v0.7.1 to match the new entityâ€‘ID scheme.

---