# ğŸ”” Tariff Slot & Phase Events

As of **v0.7.0**, this integration includes a full **event platform** that emits structured Home Assistant events whenever EDFâ€™s dynamic tariff changes in a meaningful way.

These events allow you to build automations that react instantly to:
- phase changes (green â†’ amber â†’ red)
- upcoming phase changes
- phase windows approaching their end

The event system is intentionally simple, predictable, and focused on realâ€‘world automation needs. 

---

# ğŸ“¡ Event Entity

`event.edf_fpd_phase_events`

This entity emits all tariffâ€‘related events and exposes diagnostic attributes:

- `last_event_type`
- `last_event_timestamp`
- `last_event_payload`
- `event_counts`
- `event_history`

Friendly name:

- `EDF FPD Phase Events`

---

# ğŸ§™â€â™‚ï¸ Event Types

All event types follow the naming convention:

- `edf_fpd_<description>`


The following events may be emitted:

| Event Type | Description |
|------------|-------------|
| `edf_fpd_phase_changed` | 	Fired whenever the tariff phase changes (e.g., red â†’ amber). |
| `edf_fpd_phase_ending_soon` | Fired once per phase window when the current phase is within 30 minutes of ending. |
| `edf_fpd_next_phase_changed` | Fired when the colour of the upcoming phase window changes. |


---

# ğŸ“¦ Event Payload Structure

Each event includes a structured JSON payload.  
Example:

```json
from: red
to: amber
phase:
  colour: amber
  start: "2026â€‘01â€‘27T19:00:00+00:00"
  end: "2026â€‘01â€‘27T23:00:00+00:00"
  price_p_per_kwh: 22.2075
  slot_count: 5
```

Payloads may include:

- phase
- from / to objects
- slot boundaries
- phase summaries
- price information
- timestamps
- colour (green/amber/red)
- duration and window metadata

## ğŸ§ª Example Automations

### Notify when a new phase starts

```yaml
alias: Notify on new tariff phase
trigger:
  - platform: event
    event_type: edf_fpd_phase_changed
action:
  - service: notify.mobile_app_phone
    data:
      message: >
        New tariff phase: {{ trigger.event.data.to | title }}
        ({{ trigger.event.data.phase.start }} â†’ {{ trigger.event.data.phase.end }})
```

### Trigger when the next green window becomes available

```yaml
alias: Prepare for next green window
trigger:
  - platform: event
    event_type: edf_fpd_next_phase_changed
condition:
  - condition: template
    value_template: >
      {{ trigger.event.data.to == 'green' }}
action:
  - service: script.prepare_for_green_window
```

## ğŸ“Š Example Dashboard Card

```yaml
type: markdown
title: EDF Event Timeline
content: |
  {% set diag = states['event.edf_fpd_tariff_slot_phase_events'].attributes %}
  {% if diag %}
  {% set history = diag["event_history"] %}
  {% for item in history | reverse %}
  **{{ item["timestamp"] }}**  
  ğŸ§™â€â™€ï¸ğŸª„â±ï¸ *{{ item["event_type"] }}*

  ```yaml
  {{ item["payload"] }}
  {% endfor %}
  {% endif %}
```

## ğŸ§  Debug Event Stream
If debug logging is enabled, the integration also emits:

- `edf_fpd_debug`

This includes:

- event type
- payload
- entity ID

Useful for advanced dashboards or development.

## ğŸ“Œ Notes
Event history is stored in memory only.

Events are emitted immediately when the coordinator detects a transition.

All event types follow the naming conventions documented in naming.md.

The event entity name was updated in v0.7.1 to match the new entityâ€‘ID scheme.

---