# Changelog
All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

---

## ğŸš€ [0.7.2] - 2026.01.28

## v0.7.2 â€” Phaseâ€‘Centric Event Engine Overhaul

### âœ¨ New
- Event payloads now include the **full merged phase window** rather than a single 30â€‘minute slot.
- Added a semantic `phase` object to all relevant events:
  - `colour`
  - `start` / `end` (full window boundaries)
  - `price_p_per_kwh`
  - `slot_count`
- Event entity now exposes a clearer, more automationâ€‘friendly structure.

### ğŸ”§ Changed
- Replaced slotâ€‘level event logic with a simplified, phaseâ€‘centric model.
- Removed legacy event types:
  - `edf_fpd_slot_changed`
  - `edf_fpd_phase_started`
  - `edf_fpd_phase_ended`
  - `edf_fpd_phase_block_changed`
  - `edf_fpd_next_green_phase_changed`
  - `edf_fpd_next_amber_phase_changed`
  - `edf_fpd_next_red_phase_changed`
- Updated event entity ID to `event.edf_fpd_phase_events`.
- Updated documentation and examples to reflect the new event model.

### ğŸ› Fixed
- Eliminated spurious initialisation events caused by early coordinator updates.
- Ensured phase transitions are detected reliably across merged slot blocks.
- Corrected nextâ€‘phase detection logic for edge cases around midnight.

### ğŸ§ª Developer Notes
- Diagnostics store now persists the last 5 events using the new payload format.
- Debug stream (`edf_fpd_debug`) continues to emit raw event data when enabled.

---

## ğŸš€ [v0.7.1] â€” 2026.01.27

## Entity Naming Overhaul & Seamless Migration

### âœ¨ Highlights
This release introduces a complete, futureâ€‘proof naming scheme for all entities in the integration.  
All sensors, binary sensors, events, and the debug switch now follow a consistent, tariffâ€‘aware pattern:

- `<domain>.edf_fpd_<object_id>`

Friendly names have also been updated to include the `EDF FPD` prefix, improving clarity and preparing the integration for future multiâ€‘tariff support.

A builtâ€‘in migration helper automatically updates existing entity IDs in the registry, ensuring:

- no loss of history  
- no broken dashboards  
- no broken automations  
- no user intervention required  

Only the event entity may require manual dashboard updates if it was referenced directly.

---

### ğŸ”§ Changes
- Added **entity ID migration helper** to seamlessly rename legacy entity IDs to the new `edf_fpd_*` format.
- Updated **friendly names** across all entities to include the `EDF FPD` prefix.
- Standardised **entity_id generation** using the new `build_entity_id()` helper.
- Updated the **debug logging switch** to use the new naming scheme.
- Updated the **event entity** to follow the new naming pattern.
- Improved internal consistency and futureâ€‘proofing for upcoming multiâ€‘tariff support.

---

### ğŸ› ï¸ Fixes & Improvements
- Ensured all entities attach cleanly to the integrationâ€™s device entry.
- Improved internal documentation and naming clarity.
- Minor code cleanâ€‘ups and consistency improvements.

---

### âš ï¸ Notes
- This release is **not a breaking change**.  
- All entity IDs are migrated automatically on startup.  
- If you reference the **event entity** in dashboards, you may need to update that card manually.

---

## ğŸš€ [v0.7.0] - 2026-01-26

### âœ¨ Added
- Full **event platform** (`event` domain) with structured tariff slot & phase transition events.
- New **Tariff Slot & Phase Events** entity emitting:
  - `edf_fpd_slot_changed`
  - `edf_fpd_phase_changed`
  - `edf_fpd_phase_started`
  - `edf_fpd_phase_ended`
  - `edf_fpd_phase_block_changed`
  - `edf_fpd_next_phase_changed`
  - `edf_fpd_next_green_phase_changed`
  - `edf_fpd_next_amber_phase_changed`
  - `edf_fpd_next_red_phase_changed`
- Comprehensive **event diagnostics**:
  - `last_event_type`
  - `last_event_timestamp`
  - `event_counts`
  - `event_history` (chronological, structured, retained inâ€‘memory)
- New **debug event bus stream** (`edf_fpd_debug`) for structured debugging.
- Dashboardâ€‘friendly metadata exposed via entity attributes.

### ğŸ›  Improved
- Coordinators now forward the new `event` platform during setup.
- Event entity attaches cleanly to the integrationâ€™s device registry entry.
- Diagnostics system expanded to support event tracking alongside existing EC/CC logs.
- Internal helpers extended to support block/phase formatting for event payloads.

### ğŸ§¹ Changed
- Integration version bumped to **0.7.0** to reflect the introduction of a new platform and major feature expansion.
- Minor internal refactors for consistency across coordinators, diagnostics, and event emission.

### ğŸ› Fixed
- Ensured event entity initialises previousâ€‘state tracking correctly to avoid false positives on startup.
- Improved robustness of event payload formatting for dashboard rendering.

### ğŸ“Œ Notes
- v0.6.2 contained only the addition of **standing charge diagnostics**; all other changes since v0.6.1 are included in this release.

---

## ğŸš€ [v0.6.2] - 2026-01-24

## Added standing_charges data to diagnostics

Added `standing_charges` data to diagnostics, which was originally planned for v0.6.1.

---

## ğŸš€ [v0.6.1] â€” 2026-01-23

## Standing Charges Integration & Cost Pipeline Enhancements
### Added
- **Full standingâ€‘charge support** across the integration:
  - New `async_fetch_standing_charges()` method added to `EDFCoordinator`, with robust error handling, EDFâ€‘format parsing, and heartbeatâ€‘aware failure reporting.
  - Standingâ€‘charge values (`inc_vat`, `exc_vat`, `valid_from`, `valid_to`, `raw`) now fetched on every coordinator refresh.
  - New heartbeat flags: `standing_charge_error` and `standing_charge_missing`.

- **Standingâ€‘charge fields added to the unified coordinator dataset**, making them available to all downstream consumers (sensors, diagnostics, cost coordinator).

- **CostCoordinator integration**:
  - Standingâ€‘charge values now injected into each period summary (`yesterday`, `today`).
  - New perâ€‘period fields:
    - `standing_charge_inc_vat`
    - `standing_charge_exc_vat`
    - `standing_charge_valid_from`
    - `standing_charge_valid_to`
    - `standing_charge_cost_gbp` (derived)
    - `total_cost_including_standing_gbp`
  - Topâ€‘level costâ€‘coordinator dataset now exposes standingâ€‘charge values for UI and diagnostics.

- **Cost summary sensors updated**:
  - All cost/consumption/slot summary sensors now expose standingâ€‘charge information via their `extra_state_attributes`.
  - Attributes include inc/ex VAT, validity dates, GBP/day contribution, and total cost including standing charge.

- **New dedicated sensor**: `sensor.standing_charge`
  - Displays standing charge (inc VAT) in `p/day`.
  - Attributes include exc VAT, validity dates, raw EDF JSON, and derived GBP/day value.
  - Automatically linked to the integrationâ€™s device and updated via `EDFCoordinator`.

### Improved
- Attribute structures for cost summary sensors refined to include standingâ€‘charge context without breaking existing dashboards or automations.
- Internal consistency improved across coordinators and sensors by standardising standingâ€‘charge field names and dataset structure.

### Notes
- No breaking changes to existing entity IDs, names, or device structure.
- Standingâ€‘charge values now fully integrated into the cost pipeline, enabling accurate daily cost reporting and future tariffâ€‘change awareness.

---

## ğŸš€ [v0.6.0] â€” 2026-01-21

### Major Feature Expansion & Architecture Upgrade

This release introduces a full costâ€‘calculation engine, aligned scheduling, expanded diagnostics, and a new debug logging system. It also adds binary sensors, a debug switch, and a significantly improved configuration flow.

### âœ¨ New Features
- **CostCoordinator** for accurate yesterday/today cost summaries.
- **AlignedScheduler** for predictable, jitterâ€‘aware refresh timing.
- **Debug Logging Switch** in Options Flow.
- **Binary Sensors** (e.g., â€œIs Green Slotâ€).
- **Switch Platform** for debug logging control.
- **Expanded Diagnostic Sensor** with:
  - EDFCoordinator/Cost Coordinator debug buffers and timestamps
  - Heartbeat state + subsystem flags
  - Scheduler internals (next refresh, delay, jitter)
  - Slot summaries and phase windows
  - Tariff metadata and API latency

### ğŸ”§ Improvements
- Overhauled **EDFCoordinator** with strict heartbeat model.
- Cleaner metadata extraction with HTML stripping and region label injection.
- Improved region â†’ tariff mapping logic.
- Import sensor validation with confirmation step.
- Device registration for clean entity grouping.
- Expanded sensor modules and reorganised file structure.

### ğŸ› ï¸ Fixes & Stability
- More resilient API handling with fallback datasets.
- Better staleâ€‘data detection.
- Safer startup behaviour and clearer internal state exposure.

### ğŸ“¦ Notes
- No breaking changes to entity IDs.
- Existing users migrate automatically.
- Debug logging is now controlled via the Options Flow.

---

## ğŸš€ [v0.5.0] â€” 2026-01-16

## Metadata Expansion, URL Unification & Coordinator Refactor

### âœ¨ New Features
- ğŸ“¦ Added full product metadata support via a dedicated product_url endpoint, including cleaned and normalised metadata exposed through coordinator data and diagnostics.
- ğŸ·ï¸ Introduced region label persistence (tariff_region_label) stored in the config entry and surfaced in diagnostics.
- ğŸ§° Added a new helpers module (helpers.py) containing URL builders, metadata extraction, device info, and phase utilities.
- ğŸŒ Implemented canonical URL builder (build_edf_urls) to replace hardâ€‘coded API paths across the integration.
- ğŸ” Expanded diagnostics with tariff metadata, region label, product/api URLs, and richer coordinator internals.

### ğŸ”§ Improvements
- ğŸ§  Refactored coordinator to support dualâ€‘endpoint fetching (product metadata + unit rates) and cleaner orchestration.
- ğŸ§¹ Simplified sensor setup: coordinator is now created once in __init__.py and reused by sensor.py.
- ğŸ› ï¸ Improved config flow with product URL validation, consistent region selection, and explicit region label storage.
- ğŸ”— Unified URL handling across config flow, coordinator, sensors, and diagnostics.
- ğŸ“Š Diagnostics now include current slot, current/next block summaries, and full tariff metadata.

### ğŸ Fixes
- ğŸ”„ Corrected coordinator instantiation in sensor.py by reusing the coordinator created during integration setup.
- ğŸ›¡ï¸ Improved fallback behaviour when product metadata cannot be fetched.
- ğŸ§½ Cleaned up internal field exposure in diagnostics and coordinator.

### ğŸ—ï¸ Internal Changes
- ğŸ—‚ï¸ Added new API modules: metadata.py, phases.py, product.py.
- ğŸ§© Consolidated phase grouping and formatting logic into helpers for consistency.
- ğŸ“ Normalised metadata keys to snake_case across the integration.
- ğŸ› Added additional debug logging hooks (commented out by default).


---

## [0.4.2] â€” 2026-01-14
### Added
- **Diagnostics module (`diagnostics.py`)**  
  - Fully added and integrated (previously missing from v0.4.1).  
  - Exposes scheduler state, raw forecast data, phase windows, thresholds, API latency, and timestamps.

- **Phase block summaries**  
  - New `current_block_summary` and `next_block_summary` fields.  
  - Uses unified helpers for consistent grouping and formatting.

### Changed
- **Aligned scheduler behaviour**  
  - Next refresh is now scheduled *before* the current refresh runs.  
  - Improves timing stability and avoids latencyâ€‘driven drift.  
  - Internal scheduler state now exposed for diagnostics.

- **Dataset and forecast handling**  
  - More consistent slot normalisation.  
  - Cleaner forecast slices for today, tomorrow, yesterday, and next 24 hours.

### Fixed
- Minor consistency fixes across sensors and helpers.  
- Improved internal datetime handling and stripping of internal fields.

---

## [0.4.1] â€” 2026-01-13
*(Previous release â€” diagnostics module was intended but not included)*

---

## [v0.4.0] â€” 2026-01-13

### Added
- Unified helpers for slot/phase formatting across all sensors.
- Expanded coordinator dataset:
  - `today_24_hours`
  - `yesterday_24_hours`
  - `next_24_hours`
  - `all_slots_sorted`
  - Normalised slot objects used consistently across the integration.
- New aligned refresh scheduler with jitter and exposed internal timing fields.
- Diagnostics now include:
  - Raw forecast datasets
  - Phaseâ€‘window breakdowns (yesterday, today, tomorrow, next 24h)
  - Classification thresholds
  - Coordinator internal scheduling state.
- New nextâ€‘phase sensor factory replacing fixed nextâ€‘green/amber/red sensors.

### Improved
- Forecast, slot, and metadata sensors now use unified formatting helpers.
- More consistent timestamp formatting and attribute structures.
- Cleaner internal architecture with reduced duplication and improved maintainability.

### Fixed
- More robust handling of API pagination and nonâ€‘JSON responses.
- Improved fallback behaviour when current slot cannot be determined.

### Notes
- No breaking changes to entity IDs.
- Existing configurations continue to work without modification.

---

## [v0.3.7.1] â€” 2026-01-11 (hotfix release)

### ğŸ›  Fixes & Improvements

- Corrected aligned scheduling logic to ensure refreshes occur exactly on the next boundary.
- Fixed timing issue where the "Next Refresh Time" sensor displayed the previous boundary instead of the upcoming one.
- Added `async_update_listeners()` to ensure metadata sensors update immediately after boundary advancement.
- Replaced unsafe `async_create_task` usage with proper async callback handling via `async_call_later`.
- Eliminated Home Assistant warnings about thread safety and un-awaited coroutines.
- Improved stability and predictability of the 2â€‘minute aligned refresh cycle.
- Enhanced debug sensor accuracy by switching from `_next_refresh_datetime` to `_next_boundary_utc`.

### ğŸ“¦ Notes

This release contains **no breaking changes** and is safe for all users to install.  
Recommended for anyone running v0.3.7, as it resolves several timing and asyncâ€‘related issues.

---

## [0.3.7] â€” 2026â€‘01â€‘11

### Added
- **Aligned scheduling** for API polling. Refreshes now occur on precise wallâ€‘clock boundaries based on the configured scan interval (e.g., every 5 minutes at :00, :05, :10, etc.).
- **Random jitter** (0â€“5 seconds) added to each refresh to reduce simultaneous API hits across multiple Home Assistant instances.
- **New debug sensor**: `sensor.edf_freephase_dynamic_next_refresh_time`, exposing:
  - Next scheduled refresh time (local timezone)
  - UTC timestamp of the next refresh
  - Seconds until refresh
  - Jitter applied
  - Configured scan interval

### Changed
- Coordinator now manages its own refresh cycle instead of relying on `update_interval`.
- Improved logging around refresh timing and scheduling behaviour.

### Notes
- No breaking changes.
- All existing sensors continue to function normally.

---

## [0.3.6] â€” 2026-01-11

### Changed
- Refactored the root `__init__.py` to follow modern Home Assistant integration architecture.
- Moved `EDFCoordinator` creation into `async_setup_entry`, ensuring a single coordinator instance per config entry.
- Coordinator is now stored under `hass.data[DOMAIN][entry.entry_id]` for shared access across platforms.
- Added an update listener so changes made in the Options Flow (e.g., region or scan interval) trigger a clean integration reload.
- Ensured the coordinator performs its initial refresh before sensor entities are created, improving startup reliability.
- Improved unload behaviour by removing coordinator data from `hass.data` and unloading platforms cleanly.

### Notes
- These changes affect internal architecture only; no breaking changes for users.
- All existing sensors continue to function normally, now backed by a more robust and maintainable setup flow.

---

## [0.3.5] â€“ 2026-01-09
- **Enhanced setup and options flows** with Home Assistantâ€“native selectors for region, scan interval, and import sensor.
- **Added number selector** for *Scan Interval (minutes)*, providing both slider and freeâ€‘text input for improved usability.
- **Implemented alphabetical region ordering** for a cleaner, more intuitive dropdown experience.
- **Moved all field labels to translation files**, ensuring consistent, localised UI text across setup and options flows.
- **Refactored config flow schema** to align with Home Assistantâ€™s selector requirements, resolving previous 400/500 errors.
- **Improved internal regionâ€‘mapping logic**, ensuring reliable fallback behaviour when the EDF API is unavailable.
- General code cleanup and structural improvements for longâ€‘term maintainability.

---

## [0.3.4] â€” 2026â€‘01â€‘06
### Added
- Unified slot dataset (`all_slots_sorted`) used consistently across all sensors.
- Clean, merged daily summaries for today and tomorrow with consistent formatting.
- Improved dashboardâ€‘friendly attributes for Lovelace and ApexCharts.

### Changed
- Reworked nextâ€‘block detection to correctly identify the next *different* colour block.
- Updated blockâ€‘merging logic to expand forward until the phase changes.
- Normalised phase comparisons using `.lower()` for consistent behaviour.
- Replaced stringâ€‘based datetime sorting with `start_dt` everywhere.
- Improved internal readability and maintainability across sensor modules.

### Fixed
- Corrected nextâ€‘block logic that previously returned the current block instead of the next one.
- Prevented tomorrowâ€™s earlyâ€‘morning slots from leaking into todayâ€™s summary.
- Fixed inconsistent sorting of slots and blocks across sensors.
- Resolved mismatches between slotâ€‘based and blockâ€‘based sensors.
- Fixed inconsistent formatting of start, end, duration, and price attributes.
- Ensured all sensors attach to the same device via `edf_device_info()`.

### Documentation
- README updated to reflect the new unified data model and sensor behaviour.
- Improved examples for daily summaries and blockâ€‘based dashboards.

### Summary
This release stabilises the integration, corrects several subtle logic issues, and ensures all sensors behave consistently using the unified slot dataset. It lays a clean foundation for future enhancements.

---

## [0.3.3] â€” 2026â€‘01â€‘05
### Added
- New fullâ€‘day pricing model with coordinator outputs:
  - `todays_24_hours`
  - `tomorrow_24_hours`
- Fullâ€‘day sensors:
  - `sensor.todays_rates_full`
  - `sensor.tomorrows_rates_full`
- Updated summary sensors for today and tomorrow using the new data model.
- Updated pricing sensors (cheapest slot, most expensive slot, next slot price).
- Updated slot/block sensors (current slot colour, current block summary, next block summary, next green/amber/red slot, isâ€‘greenâ€‘slot binary).

### Changed
- Replaced the rolling 24â€‘hour forecast model with a predictable fullâ€‘day structure aligned with EDFâ€™s API.
- All sensors now use the new fullâ€‘day dataset and load cleanly without `unknown` states.
- Improved duration handling and timestamp formatting.
- Coordinator behaviour made more predictable and consistent.
- Documentation updated to reflect the new data model and sensor structure.
- ApexCharts examples updated for fullâ€‘day sensors.

### Removed
- Rolling 24â€‘hour forecast model.
- `forecast.py` module.
- Forecast window configuration option.
- `sensor.24_hour_forecast`.
- All references to `next_24_hours`.

### Fixed
- Import errors and incorrect module references.
- Issues caused by deprecated forecast logic.
- Inconsistencies in duration and timestamp formatting.

### Documentation
- README fully updated.
- Removed references to forecast windows.
- Added fullâ€‘day sensor documentation.
- Clarified behaviour and internal data model.

### Upgrade Notes
- Users of the old forecast sensor should update dashboards to use the new fullâ€‘day sensors.
- If the region list appears incomplete, remove and reâ€‘add the integration to refresh dynamic region detection.
- No configuration changes required unless the forecast window option was previously used.

---

## [0.3.2] â€” 2026â€‘01â€‘05
### Added
- `last_successful_update` sensor providing timestamp of the most recent successful API fetch.
- `data_age` sensor showing how long ago the last successful update occurred.

### Changed
- Coordinator now includes automatic retry and backoff logic to reduce transient API failures.
- Improved fallback behaviour: if all retries fail, the integration uses the last successful data instead of going `unavailable`.
- Updated `coordinator_status` values to provide clearer diagnostics:
  - `ok` â€“ fresh data retrieved
  - `degraded` â€“ using cached data
  - `error` â€“ no valid data available
- Updated health sensors (`api_latency`, `last_updated`, `coordinator_status`) for richer diagnostics.
- Improved consistency across forecast, price, slot, and rate sensors.
- Updated `sensors/__init__.py` to correctly map all sensor classes.

### Fixed
- Corrected all sensor imports and class names to prevent startup errors.
- Ensured clean initialisation with no missingâ€‘sensor or import issues.
- Improved handling of missing or stale data.
- More robust timestamp formatting and safer error handling.

### Documentation
- README expanded with:
  - Full sensor list
  - Health & diagnostics section
  - Example Health Panel
  - Updated feature list
- Improved dashboard examples and formatting.

### General Improvements
- Better error logging for API failures and coordinator behaviour.
- Cleaner internal structure to support future development.

### Upgrade Notes
- Restart Home Assistant after updating to ensure new sensors and coordinator behaviour load correctly.

---

## [0.3.1] â€” 2026â€‘01â€‘05
### Added
- Dynamic tariff code detection using live data from the Kraken API.
- Automatic extraction of the region letter from the final character of each tariff code.
- Full fallback list for all Ofgem DNO regions (Aâ€“P, excluding I and O).
- Humanâ€‘friendly region labels (e.g., â€œRegion A: Eastern Englandâ€).
- New configuration options:
  - Region Code (dropdown)
  - Scan Interval (minutes)
  - Forecast Window (hours)
  - Include Past Slots

### Changed
- Config flow updated to support new dynamic region detection and additional setup fields.
- Reconfigure flow updated to match new configuration options.
- Added Userâ€‘Agent header to improve API reliability.
- Translations updated (`en.json`, `en-GB.json`, `strings.json`) to reflect new fields and descriptions.
- README updated with HACSâ€‘friendly formatting, badges, installation steps, and regionâ€‘code documentation.

### Fixed
- Improved fallback behaviour when the API is unavailable.
- Ensured region dropdown always displays the full Aâ€“P region list.
- Corrected several translation and formatting inconsistencies.

### Testing Notes
- Verified dynamic tariff code retrieval.
- Confirmed fallback region behaviour.
- Confirmed multiple instances work as separate devices.
- Verified translations and README formatting.

### Summary
This update improves robustness, simplifies configuration, and ensures longâ€‘term compatibility even if EDF updates their tariff code structure.


---

## [0.3.0] â€” 2026â€‘01â€‘05
### Added
- New merged rate summary sensors for **today** and **tomorrow**, grouping halfâ€‘hour slots into colourâ€‘based blocks.
- Each merged block now includes start time, end time, duration, colour, price, and icon.
- Coordinator now extracts tomorrowâ€™s full 24â€‘hour slot data directly from the EDF API.
- New `coordinator_status` diagnostic sensor reporting `ok` or `error` states.

### Changed
- Coordinator architecture significantly enhanced for stability and resilience.
- API calls wrapped in robust errorâ€‘handling with graceful fallback behaviour.
- Improved logging for API failures, latency, and retry behaviour.
- Modularised sensor layout for improved readability and maintainability.
- Updated `manifest.json` and `hacs.json` for better HACS compatibility.
- Documentation links and metadata cleaned up.

### Fixed
- Resolved issue where sensors could become permanently `Unavailable` after API errors.
- Corrected tomorrowâ€™s date calculation.
- Improved slot classification consistency across sensors.
- Fixed several internal references and imports.

### Documentation
- README fully rewritten with clearer installation steps.
- Updated sensor descriptions and examples.
- Improved explanation of merged block summaries and diagnostics.

### Upgrade Notes
- No breaking changes.
- Existing configurations continue to work without modification.
- Home Assistant restart recommended after updating.

---

## [Unreleased]

- Future improvements will be tracked here.