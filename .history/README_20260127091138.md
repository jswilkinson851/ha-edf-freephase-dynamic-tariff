# âš¡ EDF FreePhase Dynamic Tariff â€” Home Assistant Integration

[![hacs_badge](https://img.shields.io/badge/HACS-Custom-41BDF5.svg)](https://hacs.xyz/)
![GitHub release](https://img.shields.io/github/v/release/jswilkinson851/ha-edf-freephase-dynamic-tariff)
![GitHub license](https://img.shields.io/github/license/jswilkinson851/ha-edf-freephase-dynamic-tariff)
![GitHub last commit](https://img.shields.io/github/last-commit/jswilkinson851/ha-edf-freephase-dynamic-tariff)
![installation_badge](https://img.shields.io/badge/dynamic/json?color=41BDF5&logo=home-assistant&label=integration%20usage&suffix=%20installs&cacheSeconds=15600&url=https://analytics.home-assistant.io/custom_integrations.json&query=$.edf_freephase_dynamic_tariff.total)

This integration brings **live electricity prices**, **halfâ€‘hourly rate data**, **standing charges**, **cost tracking**, and **eventâ€‘driven tariff transitions** for the **EDF FreePhase Dynamic** tariff directly into Home Assistant.

Itâ€™s built for UK users on the FreePhase Dynamic tariff and gives you everything you need to automate, plan, and understand your energy usage â€” all using the same Kraken API that EDF themselves rely on.

---

# âœ¨ What This Integration Can Do

## ğŸ”¹ Automatic Region & Tariff Detection
Just choose your region â€” the integration fetches the correct tariff code for you.  
If EDFâ€™s API is down, it falls back to a complete builtâ€‘in list.

## ğŸ”¹ Smarter Refresh Timing (Aligned Scheduler)
Updates happen exactly on the minute or halfâ€‘hour (depending on your settings), with a tiny bit of random delay to avoid everyone hitting the API at once.

## ğŸ”¹ Cost Tracking
If you provide your electricity import sensor, the integration can calculate:
- Todayâ€™s cost  
- Yesterdayâ€™s cost  
- Cost per slot  
- Cost per phase (Green/Amber/Red)  
- Standingâ€‘charge cost contribution  
- Total cost including standing charge  

This uses your real meter readings, so the numbers reflect your actual billable usage.

## ğŸ”¹ Standing Charges
The integration fetches and exposes:
- Standing charge (inc VAT)  
- Standing charge (exc VAT)  
- Validity dates  
- Raw EDF API data  

A dedicated sensor â€” **`sensor.edf_fpd_standing_charge`** â€” provides this information cleanly.

## ğŸ”¹ Debug Logging Switch
A dedicated switch â€” **`switch.edf_fpd_debug_logging`** â€” lets you toggle detailed logging without restarting Home Assistant.

## ğŸ”¹ Better Diagnostics
A single diagnostic sensor now shows:
- API health  
- Scheduler timing  
- Current/next slot  
- Phase windows  
- Tariff metadata  
- Debug logs  
- Cost engine status  
- Standingâ€‘charge heartbeat flags  
- Event diagnostics (NEW in v0.7.0)

Perfect for troubleshooting or building a â€œhealth panelâ€.

## ğŸ”¹ Binary Sensor
- **Is it a Green slot right now?**  
  Exposed via `binary_sensor.edf_fpd_is_green_slot`.

## ğŸ”¹ Clean Device Grouping
All sensors, binary sensors, switches, and events appear under one device in Home Assistant.

---

# ğŸ› ï¸ Installation (HACS)

## Option 1 â€” HACS Custom Repository (recommended)

[![Add to HACS](https://my.home-assistant.io/badges/hacs_repository.svg)](https://my.home-assistant.io/redirect/hacs_repository/?owner=jswilkinson851&repository=ha-edf-freephase-dynamic-tariff)

1. Open **HACS â†’ Integrations â†’ Custom Repositories**  
2. Add this URL:  
   https://github.com/jswilkinson851/ha-edf-freephase-dynamic-tariff  
3. Choose **Integration**  
4. Install  
5. Restart Home Assistant  
6. Add the integration via **Settings â†’ Devices & Services**

## Option 2 â€” Manual Install
Copy the folder into `custom_components/`, restart HA, and add the integration.

---

# ğŸ—ºï¸ Region Codes

The integration fetches regionâ€‘specific tariff codes from EDFâ€™s public API.  
Each region has a letter (Aâ€“P).  
If the API is down, the integration uses a builtâ€‘in list so setup still works.

---

# âš™ï¸ Configuration Options

### **Region**
Pick your region from the list. The integration handles the tariff code.

### **Scan Interval**
How often the integration refreshes prices.  
Updates happen on exact clock boundaries (e.g., 12:00, 12:30).

### **Import Sensor (optional, but recommended)**
If you provide your electricity import meter, the integration can calculate:
- Todayâ€™s cost  
- Yesterdayâ€™s cost  
- Slotâ€‘level cost  
- Standingâ€‘charge cost contribution  

### **Debug Logging**
A simple toggle in the Options Flow.  
Useful if youâ€™re troubleshooting or want to see what the coordinator is doing.

---

# ğŸ“¡ Available Entities

All entities now follow the new naming scheme:

- `<domain>.edf_fpd_<object_id>`

Friendly names are also prefixed with:

- `EDF FPD`


This prepares the integration for future multiâ€‘tariff support.

---

## ğŸ”¹ Pricing Sensors
- `sensor.edf_fpd_current_price`  
- `sensor.edf_fpd_next_slot_price`  
- `sensor.edf_fpd_cheapest_slot`  
- `sensor.edf_fpd_most_expensive_slot`  

## ğŸ”¹ Standing Charge Sensors
- `sensor.edf_fpd_standing_charge`  
  - Attributes: exc VAT, GBP/day, validity dates, raw EDF data  

## ğŸ”¹ Cost Sensors
- `sensor.edf_fpd_cost_today`  
- `sensor.edf_fpd_cost_yesterday`  
- `sensor.edf_fpd_cost_per_slot`  
- `sensor.edf_fpd_cost_per_phase`  
- `sensor.edf_fpd_total_cost_including_standing_charge`  

## ğŸ”¹ Slot & Phase Sensors
- `sensor.edf_fpd_current_slot_colour`  
- `sensor.edf_fpd_current_phase_summary`  
- `sensor.edf_fpd_next_phase_summary`  
- `sensor.edf_fpd_next_green_slot`  
- `sensor.edf_fpd_next_amber_slot`  
- `sensor.edf_fpd_next_red_slot`  

## ğŸ”¹ Binary Sensors
- `binary_sensor.edf_fpd_is_green_slot`

## ğŸ”¹ Debug Sensors
- `sensor.edf_fpd_next_refresh_time`  
- `sensor.edf_fpd_debug_logging_enabled`  
- `sensor.edf_fpd_debug_buffers`  

## ğŸ”¹ Health & Metadata Sensors
- `sensor.edf_fpd_api_latency`  
- `sensor.edf_fpd_last_updated`  
- `sensor.edf_fpd_last_successful_update`  
- `sensor.edf_fpd_data_age`  
- `sensor.edf_fpd_cost_coordinator_status`  
- Standingâ€‘charge heartbeat flags  

---

## ğŸ”¹ Tariff Slot & Phase Events

The event entity is now:

- `event.edf_fpd_tariff_slot_phase_events`


It emits structured events whenever the tariff changes in a meaningful way.

### Event types include:
- `edf_fpd_slot_changed`
- `edf_fpd_phase_changed`
- `edf_fpd_phase_started`
- `edf_fpd_phase_ended`
- `edf_fpd_phase_block_changed`
- `edf_fpd_next_phase_changed`
- `edf_fpd_next_green_phase_changed`
- `edf_fpd_next_amber_phase_changed`
- `edf_fpd_next_red_phase_changed`

Each event includes:
- previous and next slot  
- previous and next phase  
- block summaries  
- timestamps  
- price information  
- colour (green/amber/red)  
- duration and window boundaries  

---

## ğŸ”¹ Event Diagnostics

The diagnostic sensor includes:
- `last_event_type`
- `last_event_timestamp`
- `event_counts` (perâ€‘type counters)
- `event_history` (chronological, structured)

---

## ğŸ”¹ Debug Event Stream

If debug logging is enabled, the integration emits:

- `edf_fpd_debug`


This includes:
- event type  
- payload  
- entity ID  

---

## ğŸ”¹ Example Automation

```yaml
alias: Notify when a new tariff phase starts
trigger:
  - platform: event
    event_type: edf_fpd_phase_started
action:
  - service: notify.mobile_app_phone
    data:
      message: >
        New tariff phase started: {{ trigger.event.data.phase }}
```

## ğŸ”¹ ğŸ“Š Example Dashboard Card

```yaml
type: entities
title: Daily Tariff Summary
entities:
  - entity: sensor.edf_fpd_today_phases_summary
    name: Todayâ€™s Rates
  - entity: sensor.edf_fpd_tomorrow_phases_summary
    name: Tomorrowâ€™s Rates
  - type: divider
  - entity: sensor.edf_fpd_current_price
    name: Current Price
  - entity: sensor.edf_fpd_next_slot_price
    name: Next Slot Price
  - entity: sensor.edf_fpd_current_slot_colour
    name: Current Slot Colour
  - entity: sensor.edf_fpd_standing_charge
    name: Standing Charge
```

More examples:
https://github.com/jswilkinson851/ha-edf-freephase-dynamic-tariff/tree/main/examples

## ğŸ©º Diagnostics
The downloadable diagnostics include:

- Tariff metadata
- Region label
- API URLs
- Current slot
- Phase summaries
- Scheduler timing
- Heartbeat flags
- Debug logs
- Cost engine status
- Standingâ€‘charge values and raw API data

## ğŸ›Ÿ Troubleshooting
If the region list looks short, EDFâ€™s API may be having issues â€” try again later.

Removing and reâ€‘adding the integration refreshes the region list.

If the API goes offline, the integration keeps using the last good data.

Turn on debug logging in the Options Flow for deeper insight.

## ğŸ“œ Changelog

Full release notes:
https://github.com/jswilkinson851/ha-edf-freephase-dynamic-tariff/releases

## ğŸ“„ License
MIT License.

## âš ï¸ Disclaimer
This is a community project and is not affiliated with EDF Energy or the Kraken platform.
All trademarks belong to their respective owners.

---