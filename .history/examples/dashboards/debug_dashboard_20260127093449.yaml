# ==============================================================================
# EDF FreePhase Dynamic Tariff â€” Debug & Events Dashboard (v0.7.1)
# ==============================================================================
# This dashboard provides a complete debugging and observability panel for the
# EDF FreePhase Dynamic Tariff integration.
#
# It visualises three major diagnostic streams:
#
#   1. EC Debug Logs  (EDFCoordinator)
#   2. CC Debug Logs  (CostCoordinator)
#   3. EDF Event Timeline (event.edf_fpd_tariff_slot_phase_events)
#
# ==============================================================================

type: vertical-stack
cards:
  - type: custom:mushroom-title-card
    title: ğŸ§™â€â™‚ï¸ğŸ§­ Debug & Events Panel ğŸ”®ğŸ§™â€â™‚ï¸
    alignment: center

  # ---------------------------------------------------------------------------
  # EC Debug Logs
  # ---------------------------------------------------------------------------
  - type: custom:expander-card
    title: âš¡ EC Debug Logs
    padding: 8
    cards:
      - type: markdown
        card_mod:
          style:
            ha-markdown$: |
              pre, code {
                white-space: pre-wrap !important;
                word-break: break-word !important;
              }
        content: >
          {% set times = state_attr('sensor.edf_fpd_diagnostic', 'ec_debug_times') or [] %}
          {% set logs = state_attr('sensor.edf_fpd_diagnostic', 'ec_debug_buffer') or [] %}

          {% if times and logs %}
            {% for i in range(times | length) %}
            **{{ times[i] }}**  
            <span style="color:#aaa;">
              âŒš {{ times[i] | as_timestamp | timestamp_custom("%H:%M:%S on %d %b %Y") }}
            </span>

            ğŸ§™â€â™‚ï¸ğŸ§­âœ¨ *EC Log Entry*

            ```text
            {{ logs[i] }}
            ```

            ---
            {% endfor %}
          {% else %}
            <i>No EC debug logs available.</i>
          {% endif %}

  # ---------------------------------------------------------------------------
  # CC Debug Logs
  # ---------------------------------------------------------------------------
  - type: custom:expander-card
    title: ğŸ”Œ CC Debug Logs
    padding: 8
    cards:
      - type: markdown
        card_mod:
          style:
            ha-markdown$: |
              pre, code {
                white-space: pre-wrap !important;
                word-break: break-word !important;
              }
        content: >
          {% set times = state_attr('sensor.edf_fpd_diagnostic', 'cc_debug_times') or [] %}
          {% set logs = state_attr('sensor.edf_fpd_diagnostic', 'cc_debug_buffer') or [] %}

          {% if times and logs %}
            {% for i in range(times | length) %}
            **{{ times[i] }}**  
            <span style="color:#aaa;">
              âŒš {{ times[i] | as_timestamp | timestamp_custom("%H:%M:%S on %d %b %Y") }}
            </span>

            ğŸ§™â€â™€ï¸ğŸ’·ğŸ”® *CC Log Entry*

            ```text
            {{ logs[i] }}
            ```

            ---
            {% endfor %}
          {% else %}
            <i>No CC debug logs available.</i>
          {% endif %}

  # ---------------------------------------------------------------------------
  # EDF Event Timeline
  # ---------------------------------------------------------------------------
  - type: custom:expander-card
    title: â±ï¸ EDF Event Timeline
    padding: 8
    cards:
      - type: markdown
        card_mod:
          style:
            ha-markdown$: |
              pre, code {
                white-space: pre-wrap !important;
                word-break: break-word !important;
              }
        content: |
          {% set diag = states['event.edf_fpd_tariff_slot_phase_events'].attributes %}
          {% if diag %}

          ## â±ï¸ Last Event
          **Type:** {{ diag["last_event_type"] or "â€”" }}  
          **Timestamp:** {{ diag["last_event_timestamp"] or "â€”" }}

          ---

          ## ğŸ•’ Recent Events
          {% set history = diag["event_history"] %}
          {% if history %}
            {% for item in history | reverse %}
            **{{ item["timestamp"] }}**  
            <span style="color:#aaa;">
              {{ item["timestamp"] | as_timestamp | timestamp_custom("%H:%M:%S on %d %b %Y") }}
            </span>

            ğŸ§™â€â™€ï¸ğŸª„â±ï¸ *{{ item["event_type"] }}*

            ```yaml
            {{ item["payload"] }}
            ```

            ---
            {% endfor %}
          {% else %}
            No event history yet.
          {% endif %}

          {% else %}
            No event diagnostics available.
          {% endif %}
