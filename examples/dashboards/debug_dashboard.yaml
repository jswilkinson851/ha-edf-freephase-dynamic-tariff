# ==============================================================================
# EDF FreePhase Dynamic Tariff â€” Debug & Events Dashboard (Example)
# ==============================================================================
# This example dashboard provides a complete, readyâ€‘toâ€‘use debugging and
# observability panel for the EDF FreePhase Dynamic Tariff integration.
#
# It visualises three major diagnostic streams:
#
#   1. EC Debug Logs  (EDFCoordinator)
#      - Shows raw debug messages emitted during tariff/metadata/unitâ€‘rate
#        fetching and dataset construction.
#      - Useful for understanding API behaviour, refresh timing, and internal
#        coordinator logic.
#
#   2. CC Debug Logs  (CostCoordinator)
#      - Shows debug messages related to cost calculations, importâ€‘sensor
#        processing, standingâ€‘charge integration, and costâ€‘pipeline behaviour.
#
#   3. EDF Event Timeline  (NEW in v0.7.0)
#      - Displays all tariff slot/phase/block transition events emitted by the
#        new event platform.
#      - Includes:
#          â€¢ last event type
#          â€¢ last event timestamp
#          â€¢ chronological event history
#          â€¢ full structured payloads for each event
#      - Ideal for building automations or understanding tariff transitions.
#
# Notes:
#   â€¢ This dashboard uses fenced code blocks (```text / ```yaml) for clean,
#     wrapped log output.
#   â€¢ card_mod is used to force wrapping inside <pre> and <code> blocks.
#   â€¢ All data is sourced from:
#         sensor.diagnostic_sensor
#         event.tariff_slot_phase_events
#   â€¢ This file is intended as an example only â€” users may customise layout,
#     icons, colours, or card types as desired.
#
# Compatible with:
#   - Mushroom cards
#   - expander-card
#   - card_mod
#
# Drop this file into:
#   /examples/dashboards/debug_dashboard.yaml
#
# Then import it into Home Assistant via:
#   Dashboard â†’ Three Dots â†’ Raw Configuration Editor â†’ Paste
#
# ==============================================================================

type: vertical-stack
cards:
  - type: custom:mushroom-title-card
    title: ğŸ§™â€â™‚ï¸ğŸ§­ Debug & Events Panel ğŸ”®ğŸ§™â€â™‚ï¸
    alignment: center

  - type: custom:expander-card
    title: âš¡ EC Debug Logs
    padding: 8
    cards:
      - type: markdown
        card_mod:
          style:
            ha-markdown$: |
              pre, code {
                white-space: pre-wrap !important;
                word-break: break-word !important;
              }
        content: >
          {% set times = state_attr('sensor.diagnostic_sensor',
          'ec_debug_times') or []

          %}


          {% set logs = state_attr('sensor.diagnostic_sensor',
          'ec_debug_buffer') or []

          %}



          {% if times and logs %}


          {% for i in range(times | length) %}


          **{{ times[i] }}**  

          <span style="color:#aaa;">
            âŒš {{ times[i] | as_timestamp | timestamp_custom("%H:%M:%S on %d %b %Y") }}
          </span>


          ğŸ§™â€â™‚ï¸ğŸ§­âœ¨ *EC Log Entry*



          ```text


          {{ logs[i] }}


          ```



          ---


          {% endfor %}


          {% else %}


          <i>No EC debug logs available.</i>


          {% endif %}
  - type: custom:expander-card
    title: ğŸ”Œ CC Debug Logs
    padding: 8
    cards:
      - type: markdown
        card_mod:
          style:
            ha-markdown$: |
              pre, code {
                white-space: pre-wrap !important;
                word-break: break-word !important;
              }
        content: >

          {% set times = state_attr('sensor.diagnostic_sensor',
          'cc_debug_times') or []

          %}


          {% set logs = state_attr('sensor.diagnostic_sensor',
          'cc_debug_buffer') or []

          %}



          {% if times and logs %}


          {% for i in range(times | length) %}


          **{{ times[i] }}**  


          <span style="color:#aaa;">
            âŒš {{ times[i] | as_timestamp | timestamp_custom("%H:%M:%S on %d %b %Y") }}
          </span>


          ğŸ§™â€â™€ï¸ğŸ’·ğŸ”® *CC Log Entry*



          ```text


          {{ logs[i] }}


          ```



          ---


          {% endfor %}


          {% else %}


          <i>No CC debug logs available.</i>


          {% endif %}
  - type: custom:expander-card
    title: â±ï¸ EDF Event Timeline
    padding: 8
    cards:
      - type: markdown
        card_mod:
          style:
            ha-markdown$: |
              pre, code {
                white-space: pre-wrap !important;
                word-break: break-word !important;
              }
        content: |
          {% set diag = states['event.tariff_slot_phase_events'].attributes %}
          {% if diag %}

          ## â±ï¸ Last Event
          **Type:** {{ diag["last_event_type"] or "â€”" }}  
          **Timestamp:** {{ diag["last_event_timestamp"] or "â€”" }}

          ---

          ## ğŸ•’ Recent Events
          {% set history = diag["event_history"] %}
          {% if history %}
            {% for item in history | reverse %}
            **{{ item["timestamp"] }}**  
            <span style="color:#aaa;">
              {{ item["timestamp"] | as_timestamp | timestamp_custom("%H:%M:%S on %d %b %Y") }}
            </span>
            ğŸ§™â€â™€ï¸ğŸª„â±ï¸ *{{ item["event_type"] }}*

            ```yaml
            {{ item["payload"] }}
            ```

            ---
            {% endfor %}
          {% else %}
          No event history yet.
          {% endif %}

          {% else %}
          No event diagnostics available.
          {% endif %}
